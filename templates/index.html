<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html lang="en">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    {% block head %}
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="//getbootstrap.com/examples/sticky-footer-navbar/sticky-footer-navbar.css">

    <!-- Glyphs -->
    <link rel="stylesheet" href="/static/css/whhg.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="/static/js/jquery.chained.remote.min.js"></script>
    <script src="/static/js/jquery.watch.min.js"></script>
    <script type="application/javascript" src="/static/js/noty/packaged/jquery.noty.packaged.min.js"></script>
    <title>{% block title %}{% endblock %} - My Webpage</title>
    <style type="text/css">
        .table-vcenter td {
            vertical-align: middle!important;
        }
        div.div-vcenter {
            text-align: center;
            display:table-cell;
            vertical-align:middle!important;
        }
    </style>

    <script>
        function retrieve_create_vm_tab_content() {
            var func = arguments.callee;
            $.get('/create-vm', function(data) {
                var create = $('#create');
                create.html(data);
                $("#template-select").remoteChainedTo({
                    parents: "#pool-select",
                    url: "/get-create-vm-params",
                    clear: true,
                    loading: "Loading.."
                });

                    $("#template-select").watch('disabled', function() {
                        $("#user-fullname").prop('disabled', this["disabled"]);
                        $("#username").prop('disabled', this["disabled"]);
                        $("#hostname").prop('disabled', this["disabled"]);
                        $("#password").prop('disabled', this["disabled"]);
                        $("#password2").prop('disabled', this["disabled"]);
                        $("#vm-description").prop('disabled', this["disabled"]);
                        $("#vcpus").prop('disabled', this["disabled"]);
                        $("#ram").prop('disabled', this["disabled"]);
                        $("#hdd").prop('disabled', this["disabled"]);
                        $("#redirection-http").prop('disabled', this["disabled"]);
                        $("#redirection-http-alt").prop('disabled', this["disabled"]);
                        $("#redirection-ssl").prop('disabled', this["disabled"]);
                        $("#create-button").prop('disabled', this["disabled"]);
                        var pool_info = $("#pool-info");
                        if(!this["disabled"]) {
                            var postData = $("#create-vm-form").serializeArray();
                            $.ajax({
                                url: '/get-pool-info',
                                type: "POST",
                                data: postData,
                                success: function(data, textStatus, jqXHR){
                                    console.log(data);
                                    pool_info.attr('class', 'container-fluid');
                                    console.log(data);
                                    pool_info.html(data);
                                    if ($("#no-sr-error").length) {
                                        noty({text: "<p class='lead'>" +
                                                "No default SR is associated with your XenServer pool/server:<br> " +
                                                "you are not able to create any VM with this user interface " +
                                                "until you assign it to the pool.</p>", timeout: false, type: "success"});
                                    }
                                },
                                error: function(data, textStatus, errorThrown)
                                {
                                    console.log(data);
                                    pool_info.attr('class', 'alert alert-danger');
                                    pool_info.html("<p>Can't get XenServer information. There is a chance that you will not be able to create VM here.</p>")
                                }
                            });

                        } else {
                            pool_info.attr('class', 'alert alert-info');
                            pool_info.html("<p>Select where to deploy VM to see XenServer info.</p>")
                        }
                    });
                $("#logout").click(function(e) {
                    simple_button(e, func);
                });
            });

        }

        function retrieve_vms_tab_content() {
            var func = arguments.callee;
            var vms = $('#vms');
            var notification = noty({text: "Getting VMs list"});
            $.get('/list-vms', function(data) {
                var vms = $('#vms');
                vms.html(data);
                var vms_count = $('#vms_table_body').find('tr').length;
                $('#vms_count').html(vms_count);
                notification.close();
                $('button.launch-vm').click(function(e) {
                    e.preventDefault();
                    simple_button(e, func);
                });
                $("#logout").click(function(e) {
                    simple_button(e, func);
                });
            });
        }

        function retrieve_templates_tab_content() {
            var func = arguments.callee;
            var notification = noty({text:"Getting templates list"});
            var templates = $('#templates');
            $.get('/list-templates', function(data) {
                var templates = $('#templates');
                $(templates).html(data);
                notification.close();
                var templates_count = $('#templates_table_body').find('tr').length;
                $('#templates_count').html(templates_count);
                $('button.enable-template').click(function(e) {
                    console.log(e);
                    e.preventDefault();
                    simple_button(e, func);
                });
                $('button.disable-template').click(function(e) {
                    console.log(e);
                    e.preventDefault();
                    simple_button(e, func);
                });
                $("#logout").click(function(e) {
                    simple_button(e, func);
                });

            });
        }

        function simple_button(e, func) {
            console.log(e);
            var button = $(e.target);
            console.log(button);
            var form = button.find('form');
            console.log(form);
            var notification = noty({text:"Sending request for " + button.attr('description'), type: "information"});
            console.log("notification:", notification);
            var postData = form.serializeArray();
            console.log(postData);
            var formURL = button.attr("action");
            console.log(formURL);
            $.ajax({
                url: formURL,
                type: "POST",
                data: postData,
                success: function(data, textStatus, jqXHR){
                    console.log(data);
                    console.log(jqXHR);
                    console.log(button);
                    var res = $.parseJSON(jqXHR.responseText);
                    console.log(res);
                    noty({text: res['details'], timeout: 3000, type: "success"});
                    notification.close();
                    func();
                },
                error: function(data, textStatus, errorThrown)
                {
                    console.log(data);
                    var res = $.parseJSON(data.responseText);
                    noty({text: res['details'] + ": " + res['reason'], timeout: 5000, type: "error"});
                    notification.close();
                }
            });
        }


        $(document).ready(function() {
            var vms_tab = $('#vms_tab');
            var templates_tab = $('#templates_tab');
            var create_tab = $('#create_tab');
            $.noty.defaults.layout = 'bottom';
            $.noty.defaults.timeout = 3000;

            retrieve_vms_tab_content();
            vms_tab.click(retrieve_vms_tab_content);
            templates_tab.click(retrieve_templates_tab_content);
            create_tab.click(retrieve_create_vm_tab_content);

        });


    </script>
    {% endblock %}
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="/">Virtual Machine Emperor</a>
            </div>
            <div>
                <ul class="nav nav-tabs pull-right">
                  <li class="active">
                      <a href="#vms" data-toggle="tab" id="vms_tab">
                        <span class="badge pull-right" id="vms_count"></span>
                      VMs states and properties
                      </a>
                  </li>
                  <li><a href="#create" data-toggle="tab" id="create_tab">Create VM</a></li>
                  {% if 'is_su' in session and session['is_su'] == True %}
                  <li>
                      <a href="#templates" data-toggle="tab" id="templates_tab">
                          <span class="badge pull-right" id="templates_count"></span>
                          Available Templates
                      </a>
                  </li>
                  {% endif %}
                </ul>
            </div>
            <div>
                <button
                        class="btn btn-primary"
                        type="button"
                        description="logout"
                        action="logout"
                        id="logout">
                    logout
                    <form>
                        <input name="logout" type="hidden" class="form-control" value="true">
                    </form>
                </button>
            </div>
        </div>
    </nav>
    <div class="container">
        <div class="container-fluid">
            <div class="tab-content">
              <div class="tab-pane fade in active" id="vms">
              </div>
              <div class="tab-pane fade" id="create">
              </div>
              {% if 'is_su' in session and session['is_su'] == True %}
              <div class="tab-pane fade" id="templates">
              </div>
              {% endif %}
            </div>
        </div>

    </div>
    <div id="footer">
            <p class="text-center lead">ISPRAS, 2014</p>
    </div>
</body>